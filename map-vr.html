<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Map → 360 Viewer — Incredible Jharkhand</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <style>
    html,body { height:100%; margin:0; font-family: system-ui, Arial; }
    #map { width:100%; height:100vh; }
    /* Fullscreen modal for 360 viewer */
    .viewer-modal {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      z-index:9999;
      align-items:stretch;
      justify-content:center;
      flex-direction:column;
    }
    .viewer-top {
      display:flex;
      gap:12px;
      padding:10px;
      align-items:center;
      background: linear-gradient(180deg, rgba(0,0,0,0.4), transparent);
      color:#fff;
    }
    .viewer-top .title { font-weight:700; font-size:18px; }
    .viewer-top .close-btn {
      margin-left:auto;
      background:rgba(255,255,255,0.08);
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
    }
    .viewer-scene { flex:1; min-height:0; } /* a-scene will fill */
    a-scene { width:100%; height:100%; display:block; }
    /* small note */
    .viewer-footer {
      padding:8px 12px;
      color:#ddd;
      background: linear-gradient(0deg, rgba(0,0,0,0.35), transparent);
      font-size:14px;
    }
  </style>
</head>
<body>

  <div id="map" aria-label="Interactive map"></div>

  <!-- Fullscreen 360 viewer modal -->
  <div id="viewer" class="viewer-modal" role="dialog" aria-hidden="true">
    <div class="viewer-top">
      <div class="title" id="viewerTitle">360° View</div>
      <button id="enterVr" class="close-btn" title="Enter VR">Enter VR</button>
      <button id="closeViewer" class="close-btn">Close</button>
    </div>

    <div class="viewer-scene">
      <!-- Embedded A-Frame scene; sky src will be swapped dynamically -->
      <a-scene embedded id="aframeViewer" vr-mode-ui="enabled: true">
        <a-entity camera look-controls position="0 1.6 0">
          <a-entity cursor="rayOrigin: mouse" position="0 0 -1" geometry="primitive: ring; radiusInner: .01; radiusOuter: .02" material="color: #fff"></a-entity>
        </a-entity>
        <a-sky id="viewerSky" src="" rotation="0 -90 0"></a-sky>
      </a-scene>
    </div>

    <div class="viewer-footer">
      <span id="viewerDesc">Loading...</span>
    </div>
  </div>

  <script>
    // ------- CONFIG: replace these images with your equirectangular 360 images -------
    const spots = [
      { id:'netarhat', name:'Netarhat', coords:[23.471,84.267], img360:'netarhat-360.jpg', desc:'Netarhat — hill station famous for sunrise.' , link:'/destinations/netarhat' },
      { id:'betla', name:'Betla National Park', coords:[23.847,84.217], img360:'betla-360.jpg', desc:'Betla — wildlife safaris and forests.', link:'/destinations/betla' },
      { id:'hundru', name:'Hundru Falls', coords:[23.369,85.415], img360:'hundru-360.jpg', desc:'Hundru Falls — dramatic waterfall views.', link:'/destinations/hundru-falls' },
      { id:'deoghar', name:'Deoghar', coords:[24.48,86.7], img360:'deoghar-360.jpg', desc:'Deoghar — spiritual pilgrimage hub.', link:'/destinations/deoghar' }
    ];
    // ----------------------------------------------------------------------------------

    // Initialize Leaflet map
    const map = L.map('map').setView([23.6,85.3], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap' }).addTo(map);

    // create markers and bind click -> open 360 viewer
    spots.forEach(spot => {
      const marker = L.marker(spot.coords).addTo(map);
      marker.bindPopup(`<strong>${spot.name}</strong><br/><button data-id="${spot.id}" class="open360">View 360°</button>`);
      // When popup opens, hook the button click
      marker.on('popupopen', (e) => {
        const btn = document.querySelector('.open360[data-id="' + spot.id + '"]');
        if (btn) {
          btn.addEventListener('click', () => openViewer(spot.id));
        }
      });
      // also allow clicking marker directly to open viewer
      marker.on('click', () => openViewer(spot.id));
    });

    // Viewer elements
    const viewer = document.getElementById('viewer');
    const viewerTitle = document.getElementById('viewerTitle');
    const viewerDesc = document.getElementById('viewerDesc');
    const viewerSky = document.getElementById('viewerSky');
    const aframeViewer = document.getElementById('aframeViewer');
    const closeBtn = document.getElementById('closeViewer');
    const enterVrBtn = document.getElementById('enterVr');

    // open viewer by id
    function openViewer(id) {
      const spot = spots.find(s => s.id === id);
      if (!spot) return;
      // set UI
      viewerTitle.textContent = `360°: ${spot.name}`;
      viewerDesc.textContent = spot.desc + (spot.link ? ` · More: ${spot.link}` : '');
      // set sky src (A-Frame will update texture)
      viewerSky.setAttribute('src', spot.img360);

      // show modal
      viewer.style.display = 'flex';
      viewer.setAttribute('aria-hidden', 'false');

      // set focus for accessibility
      // try to center map on spot
      map.setView(spot.coords, 9, { animate:true });
    }

    // close viewer
    function closeViewer() {
      viewer.style.display = 'none';
      viewer.setAttribute('aria-hidden', 'true');
      // optionally clear sky to free GPU memory
      viewerSky.setAttribute('src', '');
      // return focus to map container
      document.getElementById('map').focus();
    }

    closeBtn.addEventListener('click', closeViewer);

    // Enter VR fallback (tries to request VR via A-Frame)
    enterVrBtn.addEventListener('click', () => {
      if (aframeViewer && typeof aframeViewer.enterVR === 'function') {
        aframeViewer.enterVR();
      } else {
        alert('VR not available on this device/browser. Use a WebXR-enabled browser or the VR icon inside the scene.');
      }
    });

    // keyboard ESC to close
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && viewer.style.display === 'flex') closeViewer();
      // optional: 1..9 quick keys to open spots
      if (e.key >= '1' && e.key <= String(Math.min(9, spots.length))) {
        const idx = Number(e.key) - 1;
        openViewer(spots[idx].id);
      }
    });

    // Accessibility: close when clicking backdrop
    viewer.addEventListener('click', (ev) => {
      if (ev.target === viewer) closeViewer();
    });

    // Preload 360 images (optional) to reduce load lag — careful with bandwidth
    function preloadImages(list) {
      list.forEach(url => {
        const img = new Image();
        img.src = url;
      });
    }
    preloadImages(spots.map(s => s.img360));
  </script>

</body>
</html>
